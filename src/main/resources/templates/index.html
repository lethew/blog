<!DOCTYPE html>
<html lang="en" xmlns:v-on="http://www.w3.org/1999/xhtml" xmlns:th="http://www.w3.org/1999/xhtml">
<head th:replace="common/nav::commonHeader(~{::link},~{})">
    <link rel="stylesheet" href="/css/style.css"/>
</head>
<body>
<div class="container" id="app">
    <div th:include="common/nav::commonNav"></div>
    <div class="row">
        <div class="col-9">
            <div class="card">
                <div class="card-header">
                    <span>文章列表</span><span th:text="${tag}" id="tag-span"></span>
                </div>
                <div class="card-body padding-top-bottom-05" v-for="article in articles">
                    <div class="card-title">
                        <a :href="'/detail/'+article.id+'.html'" class="font-weight-bold">{{ article.title }}</a>
                        <span class="float-right font-weight-light form-control-sm">
                            阅读（<span>{{article.viewTimes}}</span>）
                        </span>
                        <span class="float-right font-weight-light form-control-sm">
                            评论（<span>{{article.comments}}</span>）
                        </span>
                    </div>
                    <div class="card-text" v-html="parseMd(article.summary)"></div>
                    <div class="card-deck row">
                        <ol class="breadcrumb col-5 bg-transparent font-weight-light form-control-sm" style="margin-bottom: 0;padding-bottom:0;">
                            <li class="breadcrumb-item">
                                <span class="oi oi-clock" title="clock" aria-hidden="true"></span>
                                发布于 {{getNowFormatDate(article.createTime)}}
                            </li>
                        </ol>
                        <ol class="breadcrumb col-7 bg-transparent font-weight-light form-control-sm" style="margin-bottom: 0;padding-bottom:0; ">
                            <a class="breadcrumb-item" v-for="tag in article.tags" :href="'/index.html?tag='+tag">
                                <span class="oi oi-tag" :title="tag" aria-hidden="true"></span>{{ tag }}</a>
                        </ol>
                    </div>
                    <hr/>
                </div>
                <div class="card-body padding-top-bottom-05" style="text-align: center;">
                    <a v-on:click="loadArticle" class="font-weight-light">{{loadString}}</a>
                </div>
            </div>
        </div>
        <div th:replace="common/nav::rightNav"></div>
    </div>
</div>

<div id="parse-md" style="display: none"><textarea></textarea></div>
<div th:include="common/nav::commonFooter"></div>
<script>
    function formatNumber(n) {
        n = n.toString()
        return n[1] ? n : '0' + n
    }
    function formatTime(date,format) {

        var formateArr  = ['Y','M','D','h','m','s'];
        var returnArr   = [];

        returnArr.push(date.getFullYear());
        returnArr.push(formatNumber(date.getMonth() + 1));
        returnArr.push(formatNumber(date.getDate()));

        returnArr.push(formatNumber(date.getHours()));
        returnArr.push(formatNumber(date.getMinutes()));
        returnArr.push(formatNumber(date.getSeconds()));

        for (var i in returnArr)
        {
            format = format.replace(formateArr[i], returnArr[i]);
        }
        return format;
    }
    Window.prototype.getNowFormatDate = function(time) {
        var date = new Date(time); // 增加8小时
        return formatTime(date, 'Y-M-D h:m:s')
    }

    Window.prototype.parseMd = function (md) {
        var testEditor = editormd.markdownToHTML("parse-md", {
            markdown:md,
            htmlDecode      : "style,script,iframe",  // you can filter tags decode
            emoji           : true,
            taskList        : true,
            tex             : true,  // 默认不解析
            flowChart       : false,  // 默认不解析
            sequenceDiagram : true,  // 默认不解析
        });
        var html = testEditor.html();
        testEditor.html("");
        return html;
    }

    var vm = new Vue({
        el:"#app",
        data:{
            loadString:"加载更多",
            page_index:0,
            articles:[]
        },
        created:function(){
            this.loadArticle();
        },
        methods:{
            loadArticle:function () {
                let _this = this;
                if(_this.page_index >= 0){
                    let tag_key = $("#tag-span").html()
                    let url = "/article/"+_this.page_index;
                    if(tag_key){
                        url += "/"+tag_key.substring(1);
                    }
                    $.get(url, function (response) {
                        console.log(response)
                        if(response.data.next){
                            _this.page_index += 1;
                        }else{
                            _this.page_index = -1;
                            _this.loadString = "没有了!!!!";
                        }
                        _this.articles = _this.articles.concat(response.data.data)

                    })
                }
            }
        }
    });
</script>
</body>
</html>